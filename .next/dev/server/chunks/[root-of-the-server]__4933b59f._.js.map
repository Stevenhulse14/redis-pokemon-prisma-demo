{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/profsteve/Documents/prisma-supabase-redis/lib/redis.ts"],"sourcesContent":["/**\n * Upstash Redis REST API client\n * Uses the REST API instead of node-redis to work in browser-based environments like v0\n */\nclass UpstashRedis {\n  private url: string;\n  private token: string;\n\n  constructor(url: string, token: string) {\n    this.url = url;\n    this.token = token;\n  }\n\n  private async handleResponse(response: Response): Promise<any> {\n    if (!response.ok) {\n      const text = await response.text();\n      throw new Error(`Redis API error: ${text}`);\n    }\n\n    const text = await response.text();\n    try {\n      return JSON.parse(text);\n    } catch {\n      throw new Error(`Invalid JSON response: ${text}`);\n    }\n  }\n\n  async get(key: string): Promise<string | null> {\n    try {\n      const response = await fetch(`${this.url}/get/${key}`, {\n        headers: {\n          Authorization: `Bearer ${this.token}`,\n        },\n      });\n      const data = await this.handleResponse(response);\n      return data.result;\n    } catch (error) {\n      console.error(\"[redis] GET error:\", error);\n      return null;\n    }\n  }\n\n  async set(\n    key: string,\n    value: string,\n    options?: { EX?: number }\n  ): Promise<string | null> {\n    try {\n      const commands = options?.EX\n        ? [\"SET\", key, value, \"EX\", options.EX.toString()]\n        : [\"SET\", key, value];\n\n      const response = await fetch(`${this.url}`, {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${this.token}`,\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(commands),\n      });\n      const data = await this.handleResponse(response);\n      return data.result;\n    } catch (error) {\n      console.error(\"[redis] SET error:\", error);\n      return null;\n    }\n  }\n\n  async incr(key: string): Promise<number> {\n    try {\n      const response = await fetch(`${this.url}/incr/${key}`, {\n        headers: {\n          Authorization: `Bearer ${this.token}`,\n        },\n      });\n      const data = await this.handleResponse(response);\n      return data.result;\n    } catch (error) {\n      console.error(\"[redis] INCR error:\", error);\n      return 0;\n    }\n  }\n\n  async mGet(keys: string[]): Promise<(string | null)[]> {\n    try {\n      const commands = [\"MGET\", ...keys];\n      const response = await fetch(`${this.url}`, {\n        method: \"POST\",\n        headers: {\n          Authorization: `Bearer ${this.token}`,\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(commands),\n      });\n      const data = await this.handleResponse(response);\n      return data.result;\n    } catch (error) {\n      console.error(\"[redis] MGET error:\", error);\n      return keys.map(() => null);\n    }\n  }\n\n  async del(key: string): Promise<number> {\n    try {\n      const response = await fetch(`${this.url}/del/${key}`, {\n        headers: {\n          Authorization: `Bearer ${this.token}`,\n        },\n      });\n      const data = await this.handleResponse(response);\n      return data.result;\n    } catch (error) {\n      console.error(\"[redis] DEL error:\", error);\n      return 0;\n    }\n  }\n}\n\n// Support both Upstash REST API and standard Redis\nlet redisClient: UpstashRedis | any | null = null;\n\nexport function getRedis(): UpstashRedis | any | null {\n  if (redisClient) return redisClient;\n\n  // Try Upstash REST API first (for serverless environments)\n  const upstashUrl = process.env.KV_REST_API_URL;\n  const upstashToken = process.env.KV_REST_API_TOKEN;\n\n  if (upstashUrl && upstashToken) {\n    console.log(\"[redis] Using Upstash REST API\");\n    redisClient = new UpstashRedis(upstashUrl, upstashToken);\n    return redisClient;\n  }\n\n  // Try standard Redis connection\n  const redisUrl = process.env.REDIS_URL;\n  if (redisUrl) {\n    try {\n      console.log(\"[redis] Using standard Redis connection:\", redisUrl);\n      const { createClient } = require(\"redis\");\n      const client = createClient({\n        url: redisUrl,\n        socket: {\n          reconnectStrategy: (retries: number) => {\n            if (retries > 10) {\n              console.error(\"[redis] Max reconnection attempts reached\");\n              return new Error(\"Max reconnection attempts reached\");\n            }\n            return Math.min(retries * 100, 3000);\n          },\n        },\n      });\n\n      // Handle connection events\n      client.on(\"error\", (err: Error) => {\n        console.error(\"[redis] Client error:\", err.message);\n      });\n\n      client.on(\"connect\", () => {\n        console.log(\"[redis] Connected to Redis\");\n      });\n\n      client.on(\"ready\", () => {\n        console.log(\"[redis] Redis client ready\");\n      });\n\n      client.on(\"reconnecting\", () => {\n        console.log(\"[redis] Reconnecting to Redis...\");\n      });\n\n      // Connect the client\n      client.connect().catch((err: Error) => {\n        console.error(\"[redis] Initial connection error:\", err.message);\n      });\n\n      // Helper function to ensure connection\n      async function ensureConnected() {\n        if (!client.isOpen) {\n          try {\n            await client.connect();\n          } catch (error: any) {\n            // Ignore \"already connecting\" errors\n            if (\n              !error.message?.includes(\"already connecting\") &&\n              !error.message?.includes(\"Socket already opened\")\n            ) {\n              throw error;\n            }\n          }\n        }\n      }\n\n      // Wrap standard Redis client to match Upstash API\n      redisClient = {\n        async get(key: string): Promise<string | null> {\n          try {\n            await ensureConnected();\n            return await client.get(key);\n          } catch (error: any) {\n            console.error(\"[redis] GET error:\", error.message || error);\n            return null;\n          }\n        },\n        async set(\n          key: string,\n          value: string,\n          options?: { EX?: number }\n        ): Promise<string | null> {\n          try {\n            await ensureConnected();\n            if (options?.EX) {\n              await client.setEx(key, options.EX, value);\n            } else {\n              await client.set(key, value);\n            }\n            return \"OK\";\n          } catch (error: any) {\n            console.error(\"[redis] SET error:\", error.message || error);\n            return null;\n          }\n        },\n        async incr(key: string): Promise<number> {\n          try {\n            await ensureConnected();\n            return await client.incr(key);\n          } catch (error: any) {\n            console.error(\"[redis] INCR error:\", error.message || error);\n            return 0;\n          }\n        },\n        async del(key: string): Promise<number> {\n          try {\n            await ensureConnected();\n            return await client.del(key);\n          } catch (error: any) {\n            console.error(\"[redis] DEL error:\", error.message || error);\n            return 0;\n          }\n        },\n        async mGet(keys: string[]): Promise<(string | null)[]> {\n          try {\n            await ensureConnected();\n            const results = await client.mGet(keys);\n            return results;\n          } catch (error: any) {\n            console.error(\"[redis] MGET error:\", error.message || error);\n            return keys.map(() => null);\n          }\n        },\n      };\n      return redisClient;\n    } catch (error) {\n      console.error(\"[redis] Failed to initialize Redis client:\", error);\n      console.warn(\"[redis] Redis caching disabled.\");\n      return null;\n    }\n  }\n\n  console.warn(\n    \"[redis] No Redis credentials found. Set KV_REST_API_URL/KV_REST_API_TOKEN (Upstash) or REDIS_URL (standard Redis). Redis caching disabled.\"\n  );\n  return null;\n}\n\nexport const redis = getRedis();\n"],"names":[],"mappings":"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"}}]
}