{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/profsteve/Documents/prisma-supabase-redis/app/api/pokemon/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { getSQL } = await import(\"@/lib/db\")\n    const { redis } = await import(\"@/lib/redis\")\n\n    const { searchParams } = new URL(req.url)\n    const query = searchParams.get(\"query\")?.trim() ?? \"\"\n    const normalizedQuery = query.toLowerCase()\n    const cacheKey = normalizedQuery ? `search:${normalizedQuery}` : \"search:all\"\n\n    // Try cache\n    if (redis) {\n      try {\n        const cached = await redis.get(cacheKey)\n        if (cached) {\n          const pokemonList = JSON.parse(cached)\n          await redis.incr(\"metrics:hits\").catch(() => {})\n          return NextResponse.json({ pokemon: pokemonList, source: \"cache\" })\n        }\n      } catch (error) {\n        console.error(\"[redis] Cache read error:\", error)\n      }\n    }\n\n    const db = getSQL()\n\n    const pokemon = normalizedQuery\n      ? await db.query(\n          `SELECT \n            id, \n            name, \n            \"spriteUrl\", \n            \"typePrimary\", \n            \"typeSecondary\"\n          FROM \"Pokemon\"\n          WHERE \n            LOWER(name) LIKE $1\n            OR LOWER(\"typePrimary\") LIKE $1\n            OR LOWER(COALESCE(\"typeSecondary\", '')) LIKE $1\n          ORDER BY id ASC`,\n          [`%${normalizedQuery}%`]\n        )\n      : await db.query(\n          `SELECT \n            id, \n            name, \n            \"spriteUrl\", \n            \"typePrimary\", \n            \"typeSecondary\"\n          FROM \"Pokemon\"\n          ORDER BY id ASC`\n        )\n\n    const pokemonRows = pokemon.rows\n\n    // Cache result\n    if (redis) {\n      try {\n        await redis.set(cacheKey, JSON.stringify(pokemonRows), { EX: 120 })\n        await redis.incr(\"metrics:misses\")\n      } catch (error) {\n        console.error(\"[redis] Cache write error:\", error)\n      }\n    }\n\n    return NextResponse.json({ pokemon: pokemonRows, source: \"db\" })\n  } catch (error) {\n    console.error(\"[api/pokemon] Error:\", error)\n    const errorMessage = error instanceof Error ? error.message : String(error)\n    const errorStack = error instanceof Error ? error.stack : undefined\n    console.error(\"[api/pokemon] Error details:\", { errorMessage, errorStack })\n    return NextResponse.json({ \n      error: \"Internal server error\", \n      message: errorMessage,\n      pokemon: [] \n    }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,IAAI,GAAgB;IACxC,IAAI;QACF,MAAM,EAAE,MAAM,EAAE,GAAG;QACnB,MAAM,EAAE,KAAK,EAAE,GAAG;QAElB,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;QACxC,MAAM,QAAQ,aAAa,GAAG,CAAC,UAAU,UAAU;QACnD,MAAM,kBAAkB,MAAM,WAAW;QACzC,MAAM,WAAW,kBAAkB,CAAC,OAAO,EAAE,iBAAiB,GAAG;QAEjE,YAAY;QACZ,IAAI,OAAO;YACT,IAAI;gBACF,MAAM,SAAS,MAAM,MAAM,GAAG,CAAC;gBAC/B,IAAI,QAAQ;oBACV,MAAM,cAAc,KAAK,KAAK,CAAC;oBAC/B,MAAM,MAAM,IAAI,CAAC,gBAAgB,KAAK,CAAC,KAAO;oBAC9C,OAAO,gJAAY,CAAC,IAAI,CAAC;wBAAE,SAAS;wBAAa,QAAQ;oBAAQ;gBACnE;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,6BAA6B;YAC7C;QACF;QAEA,MAAM,KAAK;QAEX,MAAM,UAAU,kBACZ,MAAM,GAAG,KAAK,CACZ,CAAC;;;;;;;;;;;yBAWc,CAAC,EAChB;YAAC,CAAC,CAAC,EAAE,gBAAgB,CAAC,CAAC;SAAC,IAE1B,MAAM,GAAG,KAAK,CACZ,CAAC;;;;;;;yBAOc,CAAC;QAGtB,MAAM,cAAc,QAAQ,IAAI;QAEhC,eAAe;QACf,IAAI,OAAO;YACT,IAAI;gBACF,MAAM,MAAM,GAAG,CAAC,UAAU,KAAK,SAAS,CAAC,cAAc;oBAAE,IAAI;gBAAI;gBACjE,MAAM,MAAM,IAAI,CAAC;YACnB,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,8BAA8B;YAC9C;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAa,QAAQ;QAAK;IAChE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,MAAM,eAAe,iBAAiB,QAAQ,MAAM,OAAO,GAAG,OAAO;QACrE,MAAM,aAAa,iBAAiB,QAAQ,MAAM,KAAK,GAAG;QAC1D,QAAQ,KAAK,CAAC,gCAAgC;YAAE;YAAc;QAAW;QACzE,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,OAAO;YACP,SAAS;YACT,SAAS,EAAE;QACb,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF"}}]
}